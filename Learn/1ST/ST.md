

ST电机方案





## 三相永磁同步电动机

结构

| 组建 | 结构                   |
| ---- | ---------------------- |
| 转子 | 外转子/内转子          |
|      | 表面贴装磁石内嵌式磁石 |
| 绕组 | 集中绕组，分布绕组     |

定律

| 名称     | 功能               | 公式 |
| -------- | ------------------ | ---- |
| 库伦定律 | 静止点电荷相互作用 |      |
|          |                    |      |
|          |                    |      |



#  STM32Cube

## stm32固件包介绍

Drivers

Middlewares

Projects

Utilities



### Drivers文件夹

|            名称             | 描述                                                         |
| :-------------------------: | :----------------------------------------------------------- |
|         BSP 文件夹          | 也叫板级支持包，此支持包提供的是直接与硬件打交道的 API，例如触摸屏， LCD， SRAM 以及 EEPROM 等板载硬件资源等驱动。 BSP 文件夹下面有多种 ST 官方 Discovery 开发板, Nucleo 开发板以及 EVAL 板的 硬件驱动 API 文件，每一种开发板对应一个文件夹。 |
|        CMSIS 文件夹         | 顾名思义就是符合 CMSIS 标准的软件抽象层组件相关文件。文件夹内部文件比较多。主要包括 DSP 库(DSP_LIB 文件夹)， Cortex-M 内核及其设备文件 （Include 文件夹）， 微控制器专用头文件/启动代码/ 专用系统文件等(Device 文件夹)。 |
| STM32F7xx_HAL_Driver 文件夹 | 这个文件夹非常重要，它包含了所有的 STM32F7xx 系列 HAL 库头文件和源文件，也就是所有底层硬件抽象层 API 声明和定义。 它的作用是屏蔽了复杂的 硬件寄存器操作，统一了外设的接口函数。 该文件 夹包含 Src 和 Inc 两个子文件夹，其中 Src 子文件夹 存放的是.c 源文件， Inc 子文件夹存放的是与之对应 的.h 头文件。每个.c 源文件对应一个.h 头文件。源文件名称基本遵循 stm32f7xx_hal_ppp.c 定义格式， 头文件名称基本遵循 stm32f7xx_hal_ppp.h 定义格 式。比如 gpio 相关的 API 的声明和定义在文件 stm32f7xx_hal_gpio.h 和 stm32f7xx_hal_gpio.c 中。 |

###  

### Middlewares

 该文件夹下面有 ST 和 Third_Party 2 个子文件夹。 ST 文件夹下面存放的是 STM32 相关的 一些文件，包括 STemWin 和 USB 库等。 Third_Party 文件夹是第三方中间件，这些中间价都是 非常成熟的开源解决方案。     

 

###  Project

该文件夹存放的是一些可以直接编译的实例工程。每个文件夹对应一个 ST 官方的 Demo 板。     



###  Utilities 

 该文件夹下面是一些其他组件，在项目中使用得不多。    

 



# Keil的Debug功能

汇编窗口：通过该按钮，就可以查看汇编代码，这对分析程序很有用。 

堆栈局部变量窗口：通过该按钮， 显示 Call Stack+Locals 窗口，显示当前函数的局部变量 及其值，方便查看。 观察窗口： MDK5 提供 2 个

观察窗口（下拉选择），该按钮按下，会弹出一个显示变量的 窗口， 输入你所想要观察的变量/表达式，即可查看其值， 是很常用的一个调试窗口。 

内存查看窗口： MDK5 提供 4 个内存查看窗口（下拉选择）， 该按钮按下，会弹出一个内 存查看窗口，可以在里面输入你要查看的内存地址，然后观察这一片内存的变化情况。是很常 用的一个调试窗口 

串口打印窗口： MDK5 提供 4 个串口打印窗口（下拉选择）， 该按钮按下，会弹出一个类 似串口调试助手界面的窗口，用来显示从串口打印出来的内容。 

逻辑分析窗口： 该图标下面有 3 个选项（下拉选择），我们一般用第一个，也就是逻辑分析 窗口(Logic Analyzer)，点击即可调出该窗口， 通过 SETUP 按钮新建一些 IO 口，就可以观察这 些 IO 口的电平变化情况，以多种形式显示出来，比较直观。 

系统查看窗口： 该按钮可以提供各种外设寄存器的查看窗口（通过下拉选择），选择对应外 设，即可调出该外设的相关寄存器表，并显示这些寄存器的值，方便查看设置的是否正确。    











# HAL库笔记



## 学习方法

1、掌握时钟树图

2、Datasheet，编程手册

3、多思考，多动手







## 关键文件介绍

**1、HAL 库关键文件**    

| 文件                      | 描述                                                         |
| ------------------------- | ------------------------------------------------------------ |
| stm32f7xx_hal_ppp.c/.h    | 基本外设的操作 API,ppp 代表任意外设。 其 中 stm32f7xx_hal_cortex.c/.h 比较特殊，它是 一些 Cortex 内核通用函数声明和定义，例如 中断优先级 NVIC 配置，系统软复位以及 Systick 配置等。 |
| stm32f7xx_hal_ppp_ex.c/.h | 拓展外设特性的 API。                                         |
| sm32f7xx_hal.c            | 包含 HAL 通用 API（比如 HAL_Init,HAL_DeInit,HAL_Delay 等）。 |
| stm32f7xx_hal.h           | HAL 的头文件，它应被客户代码所包含。                         |
| stm32f7xx_hal_conf.h      | HAL 的配置文件， 主要用来选择使能何种外 设以及一些时钟相关参数设置。 其本身应该 被客户代码所包含。 |
| stm32f7xx_hal_def.h       | 包含 HAL 的通用数据类型定义和宏定义                          |
| stm32f7xx_II_ppp.c/.h     | 在一些复杂外设中实现底层功能，它们在 stm32f7xx_hal_ppp.c 中被调用 |

 **2、stm32f7xx_it.c/stm32f7xx_it.h** 

 tm32f7xx_it.h 中主要是一些中断服务函数的申明。 stm32f7xx_it.h 中是这些中断服务函数定义，而这些函数定义除了 Systick 中断服务函数 SysTick_Handler 外基本都是空函数，没有任何控制逻辑。  

  

**3、stm32f7xx.h 头文件**    

头文件 stm32f7xx.h 内容看似非常少，却非常重要，它是所有 stm32f7 系列的顶层头文件。 使用 STM32F7 任何型号的芯片，都需要包含这个头文件。同时，因为 stm32f7 系列芯片型 号非常多， ST 为每种芯片型号定义了一个特有的片上外设访问层头文件，比如 STM32F767 系列， ST 定义了一个头文件 stm32f767xx.h，然后 stm32f7xx.h 顶层头文件会根据工程芯片 型号，来选择包含对应芯片的片上外设访问层头文件。    



**4、stm32f767xx.h 头文件**

根据前面的讲解， stm32f767xx.h 是 stm32f767 系列芯片通用的片上外设访问层头文件，只 要我们进行STM32F767 开发，就必然要使用到该文件。打开该文件我们可以看到里面主要 是一些结构体和宏定义标识符。这个文件的主要作用是寄存器定义声明以及封装内存操作。 



**5、system_stm32f7xx.c/system_stm32f7xx.h 文件**    

头文件 system_stm32f7xx.h和源文件 system_stm32f7xx.c主要是声明和定义了系统初始化函 数 SystemInit 以及系统时钟更新函数 SystemCoreClockUpdate。

SystemInit 函数的作用是进行 时钟系统的一些初始化操作以及中断向量表偏移地址设置，但它并没有设置具体的时钟值， 这是与标准库的最大区别，在使用标准库的时候， SystemInit 函数会帮我们配置好系统时钟 配置相关的各个寄存器。 在启动文件 startup_stm32f767xx.s 中会设置系统复位后，直接调 用 SystemInit 函数进行系统初始化。 SystemCoreClockUpdate 函数是在系统时钟配置进行修 改后，调用这个函数来更新全局变量 SystemCoreClock 的值，变量 SystemCoreClock 是一个 全局变量，开放这个变量可以方便我们在用户代码中直接使用这个变量来进行一些时钟运 算。    



**6、stm32f7xx_hal_msp.c 文件**

MSP，全称为 MCU support package,函数名字中带有 MspInit 的函数，它们的作用是进行 MCU 级别硬件初始化设置，并且它们通常会被上一层的初始化函数所调用， 这样做的目的是为了把 MCU 相关的硬件初始化剥夺出来，方便用户代码在不同型号的 MCU 上移植。 

stm32f7xx_hal_msp.c 文件定义了两个函数 HAL_MspInit 和 HAL_MspDeInit。这两个 函数分别被文件 stm32f7xx_hal.c 中的 HAL_Init 和 HAL_DeInit 所调用。 HAL_MspInit 函数的 主要作用是进行 MCU 相关的硬件初始化操作。例如我们要初始化某些硬件，我们可以硬件相关的初始化配置写在 HAL_MspDeinit 函数中。这样的话，在系统启动后调用了 HAL_Init 之 后 ， 会 自 动 调 用 硬 件 初 始 化 函 数 。 实 际 上 ， 我 们 在 工 程 模 板 中 直 接 删 掉 stm32f7xx_hal_msp.c 文件也不会对程序运行产生任何影响。  



**7、startup_stm32f767xx.s 启动文件** 

STM32 系列所有芯片工程都会有一个.s 启动文件。对于不同型号的 stm32 芯片启动文件也 是不一样的。我们的开发板是 STM32F767 系列，所以我们需要使用与之对应的启动文件 startup_stm32f767xx.s。启动文件的作用主要是进行堆栈的初始化，中断向量表以及中断函 数定义等。启动文件有一个很重要的作用就是系统复位后引导进入 main 函数。打开启动文件 startup_stm32f767xx.s，可以看到下面几行代码：    

​							**HAL 库工程文件包含关系**    

![1553590070926](C:\Users\ADMINI~1\AppData\Local\Temp\1553590070926.png)

从上面工程文件包含关系图可以看出，顶层头文件 stm32f7xx.h 直接或间接包含了其他所 有工程必要头文件，所以在我们的用户代码中，我们只需要包含顶层头文件 stm32f7xx.h 即可。    



## __weak 修饰符讲解 

weak 顾名思义是“弱”的意思，所以如果函数名称前面加上__weak 修饰符，我们一般称 这个函数为“弱函数”。加上了__weak 修饰符的函数， 用户可以在用户文件中重新定义一个同 名函数，最终编译器编译的时候，会选择用户定义的函数，如果用户没有重新定义这个函数， 那么编译器就会执行__weak 声明的函数，并且编译器不会报错 。  



## 回调函数执行过程解读

驱动方式的初始化流程就是：HAL_USART_Init()—>HAL_USART_MspInit() ，先初始化与 MCU 无 关 的 串 口 协 议 ， 再 初 始 化 与 MCU 相关的串口 引 脚 。 在 STM32 的 HAL 驱 动 中 HAL_PPP_MspInit()作为回调， 被 HAL_PPP_Init()函数所调用。当我们需要移植程序到 STM32F1 平台的时候，我们只需要修改 HAL_PPP_MspInit 函数内容而不需要修改 HAL_PPP_Init 入口参 数内容。    



## 程序执行流程图 

![1553591441420](C:\Users\ADMINI~1\AppData\Local\Temp\1553591441420.png)



## STM32基础

**MDK下C语言**

1、位操作

1) 不改变其他位的值的状况下，对某几个位进行设值。    

```c
GPIOA->ODR &=0XFF0F; //将第 4-7 位清 0
```

然后再与需要设置的值进行|或运算    

```c
GPIOA->ODR |=0X0040; //设置相应位的值，不改变其他位的值
```























