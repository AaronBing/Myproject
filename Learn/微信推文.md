# LIS3DH实现姿态检测

相信对于MEMS加速度计大家都不陌生，在我们生活中的很多项目都会使用到MEMS加速度计。

可以帮助你的机器人了解它现在身处的环境。是在爬山？还是在走下坡，摔倒了没有？或者对于飞行类的机器人来说，对于控制姿态也是至关重要的。更要确保的是，你的机器人没有带着炸弹自己前往人群密集处。一个好的工程师能够使用MEMS加速度计来回答所有上述问题。

　　目前手提电脑里也有内置了MEMS加速度计，能够动态的监测出笔记本在使用中的振动，并根据这些振动数据，系统会智能的选择关闭硬盘还是让其继续运行，这样可以最大程度的保护由于振动，比如颠簸的工作环境，或者不小心摔了电脑所造成的硬盘损害，最大程度地保护里面的数据。目前在一些先进的移动硬盘上也使用了这项技术。

　　另外一个用处就是在目前的数码相机和摄像机里，用MEMS加速度计来检测拍摄时候的手部的振动，并根据这些振动，自动调节相机的聚焦。

　　MEMS加速度计还可以用来分析发动机的振动。汽车防撞气囊的启动也可以由MEMS加速度计控制。

　　由此可见MEMS加速度计可以在我们的生活中发挥重要作用。归纳其应用主要有以下几个方面：振动检测、姿态控制、安防报警、消费应用、动作识别、状态记录等。例如检测物体是否有震动，是否发生位移。以及物体发生位移的偏转角度

---

今天给大家介绍一款MEMS加速度计

那就是ST的LIS3DH.



**LIS3DH** 是属于 “nano” 系列的超低功耗高性能 3 轴线性加速度计，具有数字 I 2C、 SPI 串行 接口标准输出。
器件具有超低功耗工作模式，可实现高级节能、智能睡眠唤醒以及恢复睡眠功能。
LIS3DH 具有 ±2g/±4g/±8g/±16g 的动态用户可选满量程，并能通过 1 Hz 到 5 kHz 的输出数 据速率测量加速度。
器件可配置为通过独立的惯性唤醒 / 自由落体事件以及通过器件自身的位置生成中断信号。
中断发生器的阈值和时序可由终端用户动态设定。
也可通过可自动编程的睡眠唤醒和恢复睡眠功能提高节能效率。
LIS3DH 集成了 32 级先进先出 (FIFO) 缓冲区供用户存储数据，从而可减少主机处理器的干预。
LIS3DH 采用纤薄的小型塑料平面网格阵列封装 (LGA)，可确保在更大的温度范围 （-40 °C 至 +85 °C）内正常工作。
SMD 封装的尺寸和重量都超小，非常适用于手持式便携应用 （比如手机和 PDA）或者任何 需要减小封装大小和重量的其他应用。

---



上面是对LIS3DH的一些基本性能的简单介绍。

那么接下来我们便进入正题，来了解一下如何用LIS3DH实现姿态检测，传统的姿态检测是直接读取当前的三个方向加速度的值，然后再mcu里面运算。但是这种方式比较耗电和对mcu的资源占用较大，所以今天给大家介绍的是如何通过配置寄存器实现姿态的中断触发。

---

![1553238743603](C:\Users\ADMINI~1\AppData\Local\Temp\1553238743603.png)

首先你要明确你要调试的角度是朝哪个方向的，上图是当mcu处于不同角度时候的X、Y、Z三个轴的方向。

由于我们只是使用翻转，并且为了节约资源，我们使用低功耗和中断触发。

## 1、模式设置

首先将工作模式设置为低功耗模式

![1553243381060](C:\Users\ADMINI~1\AppData\Local\Temp\1553243381060.png)

速率配置为25HZ

![1553243490171](C:\Users\ADMINI~1\AppData\Local\Temp\1553243490171.png)

对应的配置代码为

```c
Write 3Fh into CTRL_REG1; // 设置low power mode 和ODR = 25Hz.
```



## 2、中断触发

根据图示，将AOI1中断产生设置到INT1

![img](file:///C:/Users/ADMINI~1/AppData/Local/Temp/msohtmlclip1/01/clip_image002.jpg?lastModify=1553243637)

 对应的配置代码为

```c
Write 40h into CTRL_REG3; 
```



## 3、计算角度

假设我们要计算的倾斜角度为45度。如下图所示：

![1553246382036](C:\Users\ADMINI~1\AppData\Local\Temp\1553246382036.png)

假设我们希望当芯片的倾斜角度在蓝色区域以内，即为芯片的倾斜角度位45度以内。

首先计算 sin 45° 的值。让后再将这个阈值根据当前的标志位和灵敏度计算出需要赋给寄存器的值。

公式如下。

sin 45° = 0.707106  g

707.106 / 15.625mg / LSB = 45

换算为16进制 后为 2D

 所以最终设置的代码如下

```c
void init_LIS3DH(void)
{
Write 3Fh into CTRL_REG1; // 设置low power mode 和ODR = 25Hz.
Write 40h into CTRL_REG3; // AOI1 中断产生设置到INT1 参考图一
Write 80h into CTRL_REG4; // FS = ±2g low power mode，启动BDU
Write 0Ch into CTRL_REG5; // INT1引脚上的中断信号在D4D_INT1位使能时被锁存。
                  // 如果AOI1有中断，INT1引脚将从低电平变为高电平并保持高电平。
    			//读INT1_SRC（31h）寄存器将清除INT1引脚上的中断信号。
Write 2Dh into INT1_THS; //15.625是low_mode的灵敏度
Write 0Ah into INT1_DURATION; //持续时间= 10LSBs *（1 / 25Hz）= 0.4s。如果X轴或Y轴进入锥形区域1或锥形区域2的持续时间超过0.4秒，则会产生中断。持续时间= 0表示将立即生成中断。
Write 4Fh into INT1_CFG; // 禁用Z轴并启用XL,XH,YL,YH位的6D运动检测。
}
```

配置好后。

当板子倾斜超过45°后，INT1引脚将会产生一个高电平，直到你读取INT1_SRC（31h）寄存器后才清除。

 





























